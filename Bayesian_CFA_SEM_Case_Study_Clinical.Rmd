---
title: "Bayesianische Konfirmatorische Faktorenanalyse (CFA) und Strukturgleichungsmodellierung (SEM): Vergleich der R-Funktionen `bcfa()` und `bsem()` aus dem Paket blavaan am Beispiel klinischer Studiendaten (n = 21)"
#subtitle: "A Step-by-Step Binary Classification Approach Using Random Forest"
author: "3 D Statistical Learning"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 2
#    number_sections: true
    theme: cerulean
    highlight: tango
  pdf_document:
    toc: true
    number_sections: true
    latex_engine: xelatex
    keep_tex: true
---


# I. Einführung und Zielsetzung

In der klinischen Forschung ist es oft notwendig, **nicht direkt messbare Konstrukte** (z. B. „Schweregrad der Fatigue“) zu quantifizieren.  
Solche latenten Variablen werden in Studien häufig über **mehrere Fragebogenskalen** oder **klinische Tests** erfasst.

**Problemstellung:**  
In einer Pilotstudie zu einer seltenen Erkrankung wurden nur **21 Patient:innen** untersucht.  
Es liegen vier klinische Scores vor, die allesamt den gleichen zugrunde liegenden Schweregrad (Faktor *Disease Severity*) messen sollen.  
Die klassische Maximum-Likelihood-CFA scheitert hier oft wegen der kleinen Stichprobe.

**Ziel dieser Fallstudie:**  
Wir wollen untersuchen, ob eine **Bayesianische CFA/SEM** in der Lage ist, bei sehr kleiner Stichprobe stabile Schätzungen zu liefern,  
und vergleichen dafür die beiden Implementierungen `bcfa()` und `bsem()` aus dem R-Paket **blavaan**.

---

# II. Methodik

## II.1. Studiendesign und Datensimulation

Obwohl der Kunde uns die Erlaubnis zur methodischen Veröffentlichung seines Projekts erteilt hat, wurden die Daten zu Demonstrationszwecken simuliert. Sie orientieren sich jedoch an typischen **klinischen Studien zur Fatigue** bei chronischen Erkrankungen.  
Jede der vier Variablen entspricht einem **validierten Subscore** (z. B. körperliche Fatigue, mentale Fatigue, allgemeiner Gesundheitszustand, Aktivitätseinschränkung).

Wir simulieren:

- einen **latenten Faktor** (*Disease Severity*), normalverteilt

- vier **klinische Scores** mit hoher, aber nicht perfekter Korrelation zum Faktor

- Messfehler, um realistische klinische Datenvariabilität abzubilden

```{r plot-all-predictorssummaryday2newplot1data, message=FALSE, warning=FALSE, fig.width=15.5, fig.height=13.5}
library(blavaan)
library(bayesplot)
library(dplyr)

set.seed(1234)
n <- 21  # Kleine Pilotstudie
DiseaseSeverity <- rnorm(n, mean = 0, sd = 1)

# Faktorladungen: realistische Werte aus klinischen Skalen
lambda <- c(0.8, 0.75, 0.85, 0.7)
measurement_error <- matrix(rnorm(n * 4, mean = 0, sd = 0.5), nrow = n)

# Beobachtete Scores generieren
scores <- sweep(measurement_error, 2, lambda * DiseaseSeverity, '+')
colnames(scores) <- c("Fatigue_Physical", "Fatigue_Mental", "Health_Status", "Activity_Limitation")
df <- as.data.frame(scores)
```

---

## II.2. Modell-Spezifikation

Wir gehen davon aus, dass alle vier Scores denselben latenten Faktor *Disease Severity* messen.

```{r plot-all-predictorssummaryday2newplot1number1, message=FALSE, warning=FALSE, fig.width=15.5, fig.height=13.5}
model <- '
  DiseaseSeverity =~ Fatigue_Physical + Fatigue_Mental + Health_Status + Activity_Limitation
'
```

---

## II.3. Modellschätzung

Wir vergleichen zwei Ansätze:

1. **`bcfa()`** – optimiert für CFA-Modelle

2. **`bsem()`** – flexiblere SEM-Variante

```{r plot-all-predictorssummaryday2newplot1previous, warning=FALSE, fig.width=15.5, fig.height=13.5}
fit_bcfa <- bcfa(model, data = df,
                 burnin = 500, sample = 1000, n.chains = 2,
                 target = "stan", seed = 1)

fit_bsem <- bsem(model, data = df,
                 burnin = 500, sample = 1000, n.chains = 2,
                 target = "stan", seed = 2)
```

---

# III. Analyse & Visualisierung

## III.1. Parameterübersicht

```{r plot-all-predictorssummaryday2newplot1before, message=FALSE, warning=FALSE, fig.width=15.5, fig.height=13.5}
mcmc_bcfa <- blavInspect(fit_bcfa, "mcmc")[[1]]
mcmc_bsem <- blavInspect(fit_bsem, "mcmc")[[1]]

params_bcfa <- colnames(mcmc_bcfa)
params_bsem <- colnames(mcmc_bsem)

cat("bcfa Parameters:\n")
print(params_bcfa)

cat("bsem Parameters:\n")
print(params_bsem)
```

---

## III.2. Traceplots der Faktorladungen

```{r plot-all-predictorssummaryday2newplot1, message=FALSE, warning=FALSE, fig.width=15.5, fig.height=13.5}
color_scheme_set("brightblue")
pars_lambda_bcfa <- params_bcfa[grepl("^lambda", params_bcfa)]
mcmc_trace(mcmc_bcfa, pars = pars_lambda_bcfa)

color_scheme_set("viridisC")
pars_lambda_bsem <- params_bsem[grepl("^lambda", params_bsem)]
mcmc_trace(mcmc_bsem, pars = pars_lambda_bsem)
```

---

# IV. Interpretation

- **bcfa():** konzentriert sich auf reine CFA-Parameter, liefert kompaktere Posterior-Ausgaben.

- **bsem():** flexibler, schätzt zusätzliche Parameter, was zu mehr Posterior-Ausgaben führt.

- Beide Methoden zeigen **stabile Traceplots** ohne Anzeichen für (sehr) schlechte Konvergenz, trotz der kleinen Stichprobe.

**Klinische Relevanz:** 

Die latente Variable *Disease Severity* kann hier zuverlässig geschätzt werden, was für  
**Score-Validierung** und **klinische Entscheidungsunterstützung** wichtig ist – auch wenn nur wenige Patient:innen verfügbar sind.

---

# V. Zusammenfassung & Empfehlungen

- **Bayesianische CFA/SEM** kann bei sehr kleinen Stichproben stabilere Ergebnisse liefern als klassische Methoden. 

- Für **Pilotstudien in der Epidemiologie oder klinischen Forschung** kann diese Methode helfen,  
  latente Konstrukte wie *Symptomschwere*, *Lebensqualität* oder *Funktionsfähigkeit* zuverlässig zu quantifizieren. 
  
- `bcfa()` ist schlanker und fokussierter, `bsem()` flexibler und liefert erweiterte Modelloptionen.

- **Empfehlung:** Bei n < 30 unbedingt MCMC-Diagnosen prüfen (Traceplots, R-hat, ESS) 
  und wenn möglich **informative Priors** setzen, um klinische Vorinformationen einzubeziehen.

---
